<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyEngine EMTR Explorer | USC PPD 661</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --usc-cardinal: #990000;
            --usc-gold: #FFCC00;
            --usc-gray: #616161;
            --usc-light-gray: #F5F5F5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--usc-light-gray);
            color: #333;
        }

        .header {
            background-color: var(--usc-cardinal);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--usc-gray);
        }

        select, input[type="number"] {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--usc-cardinal);
        }

        .button-group {
            display: flex;
            gap: 1rem;
        }

        button {
            background-color: var(--usc-cardinal);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #7a0000;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--usc-gray);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--usc-light-gray);
            border-top: 4px solid var(--usc-cardinal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .charts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            color: var(--usc-cardinal);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .chart-container canvas {
            max-height: 400px;
        }

        .insights {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(--usc-cardinal);
            margin-top: 2rem;
        }

        .insights h2 {
            color: var(--usc-cardinal);
            margin-bottom: 1rem;
        }

        .insight-box {
            background: var(--usc-light-gray);
            padding: 1rem;
            border-left: 4px solid var(--usc-gold);
            margin-bottom: 1rem;
        }

        .insight-box h3 {
            color: var(--usc-cardinal);
            margin-bottom: 0.5rem;
        }

        .cliff-list {
            list-style: none;
        }

        .cliff-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
        }

        .cliff-emtr {
            color: var(--usc-cardinal);
            font-weight: 700;
        }

        .error {
            background-color: #fee;
            color: #c00;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PolicyEngine EMTR Explorer</h1>
        <p>USC PPD 661: Understanding Effective Marginal Tax Rates and Benefit Cliffs</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="state">State</label>
                    <select id="state">
                        <option value="CA">California</option>
                        <option value="TX">Texas</option>
                        <option value="NY">New York</option>
                        <option value="FL">Florida</option>
                        <option value="IL">Illinois</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="OH">Ohio</option>
                        <option value="GA">Georgia</option>
                        <option value="NC">North Carolina</option>
                        <option value="MI">Michigan</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="children">Number of Children</label>
                    <select id="children">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="maxIncome">Maximum Income ($)</label>
                    <input type="number" id="maxIncome" value="100000" min="20000" max="200000" step="10000">
                </div>
            </div>

            <div class="button-group">
                <button id="calculateBtn">Calculate</button>
                <button id="exportBtn" style="background-color: var(--usc-gold); color: #333;">Export Data</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Calculating income profiles across all earnings levels...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" style="display: none;">
            <div class="charts">
                <div class="chart-container">
                    <h2>Net Income by Employment Income</h2>
                    <canvas id="netIncomeChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>Effective Marginal Tax Rate (EMTR) by Income Level</h2>
                    <canvas id="emtrChart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>Program Benefits by Income Level</h2>
                    <canvas id="benefitsChart"></canvas>
                </div>
            </div>

            <div class="insights">
                <h2>Key Findings</h2>
                <div id="insightsContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let charts = {
            netIncome: null,
            emtr: null,
            benefits: null
        };

        document.getElementById('calculateBtn').addEventListener('click', calculateProfile);
        document.getElementById('exportBtn').addEventListener('click', exportData);

        async function calculateProfile() {
            const state = document.getElementById('state').value;
            const children = parseInt(document.getElementById('children').value);
            const maxIncome = parseInt(document.getElementById('maxIncome').value);

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('calculateBtn').disabled = true;

            try {
                const response = await fetch('https://policyengine-emtr-backend.onrender.com/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        state: state,
                        children: children,
                        min_income: 0,
                        max_income: maxIncome,
                        step: 2500
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to calculate. Make sure the backend is running.');
                }

                currentData = await response.json();
                displayResults();

            } catch (error) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${error.message}. Make sure to start the backend with: python3 backend.py`;
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('calculateBtn').disabled = false;
            }
        }

        function displayResults() {
            document.getElementById('results').style.display = 'block';

            const incomes = currentData.map(d => d.employment_income);
            const netIncomes = currentData.map(d => d.household_net_income);
            const emtrs = currentData.map(d => (d.emtr !== null ? d.emtr * 100 : null));
            const snap = currentData.map(d => d.snap);
            const eitc = currentData.map(d => d.eitc);
            const ctc = currentData.map(d => d.ctc);

            // Net Income Chart
            if (charts.netIncome) charts.netIncome.destroy();
            const netIncomeCtx = document.getElementById('netIncomeChart').getContext('2d');
            charts.netIncome = new Chart(netIncomeCtx, {
                type: 'line',
                data: {
                    labels: incomes,
                    datasets: [{
                        label: 'Net Income',
                        data: netIncomes,
                        borderColor: '#990000',
                        backgroundColor: 'rgba(153, 0, 0, 0.1)',
                        borderWidth: 3,
                        tension: 0.1
                    }, {
                        label: '45¬∞ Line (Net = Gross)',
                        data: incomes,
                        borderColor: '#666',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Employment Income ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value/1000) + 'k';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Net Income ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value/1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });

            // EMTR Chart
            if (charts.emtr) charts.emtr.destroy();
            const emtrCtx = document.getElementById('emtrChart').getContext('2d');
            charts.emtr = new Chart(emtrCtx, {
                type: 'line',
                data: {
                    labels: incomes,
                    datasets: [{
                        label: 'EMTR (%)',
                        data: emtrs,
                        borderColor: '#990000',
                        backgroundColor: 'rgba(153, 0, 0, 0.1)',
                        borderWidth: 3,
                        tension: 0.1,
                        segment: {
                            borderColor: ctx => {
                                const value = ctx.p1.parsed.y;
                                return value > 50 ? '#cc0000' : '#990000';
                            },
                            backgroundColor: ctx => {
                                const value = ctx.p1.parsed.y;
                                return value > 50 ? 'rgba(204, 0, 0, 0.2)' : 'rgba(153, 0, 0, 0.1)';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 50,
                                    yMax: 50,
                                    borderColor: '#FFCC00',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: '50% threshold',
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Employment Income ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value/1000) + 'k';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'EMTR (%)'
                            },
                            min: -20,
                            max: 100
                        }
                    }
                }
            });

            // Benefits Chart
            if (charts.benefits) charts.benefits.destroy();
            const benefitsCtx = document.getElementById('benefitsChart').getContext('2d');
            charts.benefits = new Chart(benefitsCtx, {
                type: 'line',
                data: {
                    labels: incomes,
                    datasets: [{
                        label: 'SNAP',
                        data: snap,
                        borderColor: '#2E7D32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 2,
                        tension: 0.1
                    }, {
                        label: 'EITC',
                        data: eitc,
                        borderColor: '#1976D2',
                        backgroundColor: 'rgba(25, 118, 210, 0.1)',
                        borderWidth: 2,
                        tension: 0.1
                    }, {
                        label: 'CTC',
                        data: ctc,
                        borderColor: '#FFCC00',
                        backgroundColor: 'rgba(255, 204, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Employment Income ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value/1000) + 'k';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Benefit Amount ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Generate insights
            generateInsights();
        }

        function generateInsights() {
            const cliffs = currentData.filter(d => d.emtr !== null && d.emtr > 0.5);

            let html = '';

            // Benefit cliffs
            if (cliffs.length > 0) {
                html += `<div class="insight-box">
                    <h3>‚ö†Ô∏è Benefit Cliffs Found: ${cliffs.length} income ranges</h3>
                    <p>These are income levels where earning an additional $1,000 results in losing more than $500 in net income (EMTR > 50%).</p>
                    <ul class="cliff-list">`;

                cliffs.slice(0, 5).forEach(point => {
                    html += `<li class="cliff-item">
                        At $${point.employment_income.toLocaleString()}:
                        <span class="cliff-emtr">EMTR = ${(point.emtr * 100).toFixed(1)}%</span>
                        (Net income: $${point.household_net_income.toLocaleString()})
                    </li>`;
                });

                html += `</ul></div>`;
            }

            // Program phases
            html += `<div class="insight-box">
                <h3>üìä Program Interactions</h3>
                <p>Multiple programs interact to create the effective marginal tax rate:</p>
                <ul>
                    <li><strong>SNAP:</strong> Phases out as income rises, creating implicit tax</li>
                    <li><strong>EITC:</strong> Has phase-in, plateau, and phase-out regions</li>
                    <li><strong>CTC:</strong> Phases in with earned income, then plateaus</li>
                    <li><strong>Medicaid:</strong> Cliff eligibility at specific thresholds</li>
                </ul>
            </div>`;

            // Max EMTR
            const maxEMTR = Math.max(...currentData.filter(d => d.emtr !== null).map(d => d.emtr));
            const maxEMTRPoint = currentData.find(d => d.emtr === maxEMTR);

            html += `<div class="insight-box">
                <h3>üìà Highest EMTR</h3>
                <p>The highest effective marginal tax rate is <span class="cliff-emtr">${(maxEMTR * 100).toFixed(1)}%</span>
                at employment income of $${maxEMTRPoint.employment_income.toLocaleString()}.</p>
            </div>`;

            document.getElementById('insightsContent').innerHTML = html;
        }

        function exportData() {
            if (!currentData) {
                alert('No data to export. Please calculate first.');
                return;
            }

            const csv = convertToCSV(currentData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `policyengine_data_${document.getElementById('state').value}_${document.getElementById('children').value}kids.csv`;
            a.click();
        }

        function convertToCSV(data) {
            const headers = ['employment_income', 'household_net_income', 'emtr', 'snap', 'eitc', 'ctc', 'income_tax', 'payroll_tax'];
            let csv = headers.join(',') + '\n';

            data.forEach(row => {
                const values = headers.map(header => row[header] ?? '');
                csv += values.join(',') + '\n';
            });

            return csv;
        }

        // Load initial calculation on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('calculateBtn').click();
            }, 500);
        });
    </script>
</body>
</html>
